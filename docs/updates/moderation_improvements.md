# 審核系統改進更新

## 更新日期
2024-04-16 (更新於: 2024-04-23)

## 概述
本次更新主要針對內容審核系統進行了一系列優化，特別是對誤判處理邏輯的改進、嚴重違規內容處理的加強以及備用AI服務支持的添加。系統現在能更準確地識別誤判情況，避免因文化差異導致的錯誤審核，對誤判的內容不再發送通知或採取任何措施，同時對於審核AI服務返回空回應的情況，會嘗試使用備用AI服務進行審核。

## 主要變更

### 1. 誤判處理邏輯改進
- 增強了對「誤判」的檢測能力，現在系統能夠識別更廣泛的關鍵詞和上下文
- 擴展了關鍵詞列表，包括：「誤判」、「誤報」、「歌曲」、「遊樂」、「誤解」、「文化」、「遊戲」、「沒有違規」等
- 對被判定為誤判的內容，系統不會刪除消息，也不會禁言用戶
- 移除了對誤判情況的用戶通知，避免不必要的干擾

### 2. 嚴重違規內容處理加強
- 添加了嚴重違規詞彙檢測功能，能夠直接識別明顯違反社群規範的語言
- 實現了多重違規類型組合檢測，當內容同時觸發多個違規類型時自動判定為違規
- 增強了對AI評估失敗或返回空白回應時的處理機制
- 對於嚴重違規內容會跳過複雜的AI評估，直接判定為違規並採取相應措施

### 3. 備用AI服務支持
- 添加了備用AI服務配置，當主要AI服務返回空回應時自動切換
- 實現了服務失敗的優雅降級，確保即使一個服務不可用時系統仍能正常運行
- 優化了日誌輸出，清晰顯示當前使用的是主要服務還是備用服務
- 保證了服務之間的平滑轉換，用戶無需感知系統在不同AI服務間的切換

### 4. 日誌系統改進
- 重新設計了日誌格式，使其更加結構化和易於閱讀
- 添加了「[審核]」和「[審核系統]」前綴來明確標識相關日誌
- 增加了更詳細的調試信息，包括響應解析過程和決策依據
- 限制了過長的原始響應，避免日誌過度膨脹

### 5. 響應解析優化
- 改進了對AI響應的解析邏輯，更可靠地提取決策結果
- 添加了對不同引號類型的處理（英文引號、中文全形引號等）
- 增強了錯誤處理機制，避免解析失敗導致系統崩潰
- 添加了多重備份判斷機制，確保即使主要評估途徑失敗，也能做出合理決策

## 技術細節

### 備用AI服務配置
系統現在支持配置備用的AI服務和模型，通過以下環境變數：
```
# 主要審核服務配置
MODERATION_REVIEW_AI_SERVICE=azureopenai
MODERATION_REVIEW_MODEL=gpt-4o

# 備用審核服務配置
BACKUP_MODERATION_REVIEW_AI_SERVICE=gemini
BACKUP_MODERATION_REVIEW_MODEL=gemini-pro
```

備用服務只在以下情況下被啟用：
1. 已正確配置備用服務和模型
2. 主要服務返回空回應或發生錯誤
3. 內容不符合嚴重違規的快速判定條件

### 嚴重違規內容判定機制
當系統檢測到內容包含以下任一情況時，會自動判定為嚴重違規：
1. 短消息（少於30字符）且包含明確的違規詞彙（如辱罵、威脅、自傷相關詞彙）
2. 同時觸發3種或更多種違規類型（如同時包含騷擾、自傷和暴力內容）
3. 包含系統預設的嚴重違規詞彙，如：強姦、自殺、殺人等敏感詞彙

對於嚴重違規內容，系統會：
- 跳過複雜的AI評估過程，直接判定為違規
- 即使AI評估過程出錯，也能正確處理並禁言用戶
- 提供更具體的違規原因說明

### 改進的審核流程
1. 系統收到潛在違規內容後，首先通過OpenAI的審核API進行初步檢測
2. 檢查是否符合嚴重違規的快速判定條件，如果是則直接判定為違規
3. 否則，使用主要AI服務進行內容審核
4. 如果主要服務返回空回應或出錯，嘗試使用備用AI服務
5. 如果備用服務也失敗，根據違規類型和內容特徵進行保守判定
6. 根據最終審核結果決定是否刪除消息和禁言用戶

### 系統響應示例
當系統檢測到「跳樓機」等具有文化背景的詞彙，通過主要服務成功審核時：
```
[審核] 開始評估內容是否為誤判，被標記類型: self_harm
[審核] 內容片段: 明天一起去玩跳樓機吧！好期待啊！...
[審核] 使用主要AI服務評估內容
[審核] 主要AI服務：使用 data 屬性獲取响應
[審核] 主要AI服務：响應文本: FALSE_POSITIVE: "跳樓機"在此語境中是指一種遊樂設施，而非與自殘相關的內容。這是娛樂場所中常見的遊樂設備...
[審核] 檢測到 false_positive: 前綴
[審核結果] 誤判 - "跳樓機"在此語境中是指一種遊樂設施，而非與自殘相關的內容。這是娛樂場所中常見的遊樂設備...
[審核系統] 用戶 xiao.bo. 的訊息審核結果: 非違規(誤判)
[審核系統] 誤判原因: "跳樓機"在此語境中是指一種遊樂設施，而非與自殘相關的內容。這是娛樂場所中常見的遊樂設備...
```

當主要服務返回空回應，系統切換到備用服務時：
```
[審核] 開始評估內容是否為誤判，被標記類型: harassment, self_harm
[審核] 內容片段: 某個需要評估的內容...
[審核] 使用主要AI服務評估內容
[審核] 主要AI服務：收到空響應
[審核] 主要AI服務未返回有效結果，嘗試使用備用AI服務
[審核] 使用備用AI服務評估內容
[審核] 備用AI服務：使用 data 屬性獲取响應
[審核] 備用AI服務：响應文本: VIOLATION: 內容包含針對他人的侮辱性語言和威脅，違反了社群規範中關於騷擾的規定...
[審核結果] 違規 - 內容包含針對他人的侮辱性語言和威脅，違反了社群規範中關於騷擾的規定...
[審核系統] 用戶 user_name 的訊息審核結果: 確認違規
[審核系統] 已刪除標記為違規的發送消息，用戶: user_name
[審核系統] 用戶 user_name 禁言狀態: True
```

## 環境變數配置
新增以下環境變數配置選項：
```
# 備用審核服務配置
BACKUP_MODERATION_REVIEW_AI_SERVICE=gemini  # 備用AI服務，如gemini, anthropic等
BACKUP_MODERATION_REVIEW_MODEL=gemini-pro   # 備用模型名稱
```

## 使用指南
1. 在 `.env` 文件中配置備用審核服務（可選）
2. 如果不配置備用服務，系統仍然可以正常運行，但在主要服務失敗時將沒有備用機制
3. 審核系統的其他改進是自動生效的，不需要任何額外設置

這次更新大大提高了審核系統的可靠性和準確性，通過多種AI服務的結合和智能降級策略，確保系統能夠在各種情況下做出正確的判斷，同時最大限度地減少誤判帶來的不良體驗。 