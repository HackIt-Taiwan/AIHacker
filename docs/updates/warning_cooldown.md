# 不安全連結警告優化：30秒冷卻機制

日期：2024-03-27

## 概述

本次更新優化了不安全連結（黑名單URL）警告的顯示邏輯，引入了30秒的警告冷卻期。當用戶在短時間內發送多個黑名單URL時，系統將僅在第一次違規時顯示警告，後續30秒內不再重複顯示警告，從而減少頻道干擾並提升用戶體驗。

## 背景問題

在之前的實現中，每當用戶發送包含黑名單URL的消息時，系統都會：

1. 立即刪除包含危險URL的消息
2. 向用戶發送一條警告通知，解釋刪除原因

當用戶在短時間內連續發送多條包含黑名單URL的消息時，會導致以下問題：

- 用戶收到過多重複的警告通知
- 頻道內充斥著大量重複的警告消息
- 這些警告可能干擾正常對話和頻道閱讀體驗

## 解決方案

我們引入了警告冷卻機制，通過以下方式解決上述問題：

1. **冷卻期機制**：用戶在30秒內只會收到一次警告通知
2. **獨立警告跟踪**：新增全局字典`warning_times`專門跟踪用戶警告顯示時間
3. **智能警告邏輯**：檢查用戶最近30秒內是否已收到警告，從而決定是否顯示新警告

## 技術實現

我們對`main.py`中的`check_urls_immediately`函數進行了以下修改：

1. 新增全局變量
```python
# 跟踪用戶警告顯示時間
warning_times = {}
```

2. 優化警告顯示邏輯
```python
# 檢查用戶是否在最近30秒內已收到警告
current_time = time.time()
warning_cooldown = 30  # 30秒冷卻期

# 檢查是否在冷卻期內
warning_shown = False
if str(message.author.id) in warning_times:
    last_warning_time = warning_times[str(message.author.id)]
    if current_time - last_warning_time < warning_cooldown:
        warning_shown = True

# 僅在冷卻期外顯示警告
if not warning_shown:
    # 發送警告通知
    warning_times[str(message.author.id)] = current_time
    # 發送通知邏輯...
```

## 行為變化

用戶發送黑名單URL的體驗將會有以下變化：

1. **第一次違規**：
   - 消息立即被刪除
   - 用戶收到一條警告通知
   - 系統記錄此次警告時間

2. **冷卻期內再次違規**：
   - 消息立即被刪除
   - 用戶不會收到重複警告
   - 系統繼續執行其他懲罰機制（例如違規計數增加）

3. **冷卻期後違規**：
   - 消息立即被刪除
   - 用戶再次收到警告通知
   - 系統更新警告時間記錄

## 預期效果

此優化將帶來以下效果：

1. **減少頻道干擾**：大幅減少短時間內的重複警告通知
2. **改善用戶體驗**：保持頻道整潔，同時不影響安全監控
3. **保持安全性**：所有危險URL仍會被立即刪除
4. **用戶教育**：用戶仍會意識到自己發送了不安全連結

## 未來計劃

未來我們可能考慮以下改進：

1. 將冷卻時間設為可配置參數
2. 根據用戶行為模式探索更智能的警告策略
3. 優化警告消息的清晰度和訊息傳達效果

## 相關更新

- [黑名單URL懲罰系統增強](blacklist_punishment.md)
- [URL安全檢查消息刪除優化](url_delete_retry.md) 