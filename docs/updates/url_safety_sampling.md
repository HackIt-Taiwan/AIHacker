# URL 安全檢查系統更新：隨機抽樣功能

## 摘要
本次更新為 URL 安全檢查系統添加了隨機抽樣功能，當用戶在一則訊息中發送超過設定數量的連結時，系統會隨機選擇部分連結進行檢查，提高效率並減少 API 請求。

## 功能說明

1. **隨機抽樣檢查**：
   - 當用戶在一則訊息中發送超過設定數量的連結時，系統會隨機抽取指定數量的連結進行安全檢查
   - 未被抽中檢查的連結會被標記為「跳過」，不進行安全檢查
   - 可通過環境變數設置抽樣數量

2. **配置選項**：
   - 新增 `URL_SAFETY_MAX_URLS` 環境變數，用於設定一次最多檢查的連結數量
   - 默認值為 5，可根據需求調整

3. **日誌記錄**：
   - 系統會在日誌中記錄抽樣情況，便於追蹤
   - 當有抽樣且未發現危險連結時，會記錄特別提示

## 技術實現

1. **抽樣邏輯**：
   ```python
   if len(urls) > URL_SAFETY_MAX_URLS:
       sampling_applied = True
       urls_to_check = random.sample(urls, URL_SAFETY_MAX_URLS)
       # 處理被跳過的連結...
   ```

2. **結果格式**：
   對於被跳過的連結，結果格式如下：
   ```python
   {
       "url": "https://example.com",
       "is_unsafe": False,
       "check_time": "2023-07-30T12:34:56",
       "message": "URL check skipped (random sampling applied)",
       "skipped": True
   }
   ```

## 使用示例

環境變數設置示例：
```
URL_SAFETY_MAX_URLS=5  # 設定一次最多檢查 5 個連結
```

當用戶發送含有 8 個連結的訊息時：
- 系統會隨機選擇 5 個連結進行安全檢查
- 其餘 3 個連結會被標記為「跳過」
- 如果被檢查的 5 個連結中有任何一個被判定為不安全，整個訊息仍會被標記為不安全

## 優勢

1. **降低 API 使用率**：減少對外部 API 的請求數量，節省資源
2. **提高回應速度**：減少需要檢查的連結數量，提高處理速度
3. **維持安全性**：透過隨機抽樣，仍能維持一定的安全檢查覆蓋率
4. **可配置性**：通過環境變數可以輕鬆調整抽樣數量，適應不同需求

## 注意事項

- 隨機抽樣可能會錯過某些危險連結，但通過合理設置抽樣數量，可以在效率和安全性之間取得平衡
- 如果需要更高的安全保障，可以增大 `URL_SAFETY_MAX_URLS` 的值 