# Docker 支援更新 (2024-03-31)

## 更新內容

本次更新為 AIHacker Discord Bot 新增了 Docker 支援，允許使用者透過容器化技術輕鬆部署和運行機器人服務，並特別優化了雲端環境部署。

### 新增功能

- **Dockerfile**: 為應用程式建立了專用的 Docker 容器化配置
- **docker-compose.yml**: 提供了簡便的容器協調配置
- **資料持久化**: 通過卷掛載確保資料庫和日誌資料的持久保存
- **非 root 用戶運行**: 增強安全性，容器內使用非特權用戶運行應用
- **環境變數支援**: 同時支援 `.env` 檔案和直接設置環境變數兩種方式
- **雲端友好設計**: 針對雲端環境優化，支援雲端平台的密鑰管理系統
- **時區設定**: 預設配置為台灣時區 (Asia/Taipei)
- **自動重啟**: 配置容器在發生錯誤時自動重啟

### 技術實現

1. **容器基礎鏡像**:
   - 使用 `python:3.10-slim` 作為基礎鏡像，平衡了鏡像大小和功能性

2. **安全性增強**:
   - 創建並使用非 root 用戶 `botuser` 運行應用
   - 合理設置資料夾權限
   - 提供適合雲端環境的配置選項，避免將敏感資訊直接掛載到容器中

3. **資料持久化**:
   - 為 `data/` 目錄配置卷掛載，確保資料庫檔案持久保存
   - 為 `logs/` 目錄配置卷掛載，保存應用日誌
   - 使用環境變數或 `env_file` 進行配置管理，更適合雲端環境

4. **環境變數靈活性**:
   - 支援多種配置注入方式：
     - 本地開發：通過 `.env` 檔案和 `env_file` 指令
     - 生產環境：直接傳遞環境變數給容器
     - 雲端部署：利用雲平台的密鑰管理系統

5. **容器健康檢查**:
   - 實現基本的容器健康檢查機制，確保服務可用性

## 部署說明

詳細的部署指南請參考 [Docker 部署指南](../docker_deployment.md)。

### 本地開發使用方法

1. 準備環境檔案:
   ```bash
   cp .env.example .env
   # 編輯 .env 檔案填寫必要的設定
   ```

2. 啟動服務:
   ```bash
   docker-compose up -d
   ```

### 雲端環境使用方法

1. 修改 docker-compose.yml:
   ```yaml
   services:
     discord-bot:
       # ...其他設定...
       volumes:
         - ./data:/app/data
         - ./logs:/app/logs
         # 註釋掉 .env 掛載
         # - ./.env:/app/.env
       # 註釋掉 env_file 指令
       # env_file:
       #   - ./.env
       environment:
         - TZ=Asia/Taipei
         - DISCORD_TOKEN=${DISCORD_TOKEN}
         - PRIMARY_AI_SERVICE=${PRIMARY_AI_SERVICE}
         # 其他必要的環境變數
   ```

2. 使用雲平台提供的環境變數或密鑰管理系統設置必要的變數。

## 效能提升

- **輕量級容器**: 使用精簡的基礎鏡像減少資源消耗
- **快速啟動**: 透過合理的依賴管理加速容器啟動過程
- **自動化部署**: 簡化了跨平台部署流程
- **雲端適配**: 配置優化適合各種雲端平台，包括 AWS, Azure, GCP 等

## 注意事項

- Docker 部署需要主機安裝 Docker 和 Docker Compose
- 初次使用 Docker 的用戶建議先閱讀 [Docker 官方文檔](https://docs.docker.com/)
- 雲端環境建議使用環境變數或密鑰管理系統，而非直接掛載 `.env` 檔案
- 所有必要的 API 密鑰和配置仍需設置，無論使用何種配置注入方式 