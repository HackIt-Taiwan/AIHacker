# 內容審核複查系統

## 功能概述

內容審核複查系統是一個增強型功能，旨在解決內容審核系統可能出現的誤判問題。當 OpenAI 審核 API 標記訊息含有違規內容時，複查系統會使用 AI 代理來評估該內容是否真正違反社群規範，還是一個誤判。

## 主要特點

- **智能誤判識別**：能夠識別歌曲名稱、書名、專業術語等容易被誤判的內容
- **上下文分析**：考慮訊息的上下文，提高判斷準確度
- **多模型支援**：可自行選擇 AI 服務和模型來執行複查
- **詳細解釋**：在通知中提供審核結果的具體解釋
- **防止誤處罰**：避免因誤判而對用戶實施不必要的禁言或其他處罰

## 工作流程

1. 內容首先經過 OpenAI 的內容審核 API 進行評估
2. 如果內容被標記為違規，系統不會立即刪除訊息或禁言用戶
3. 複查 AI 代理會評估被標記的內容是否為誤判
4. 僅當複查代理確認內容確實違規時，訊息才會被刪除並對用戶實施處罰
5. 審核結果會顯示在頻道通知和私訊中，提供處罰依據

## 配置說明

在 `.env` 文件中，可以配置以下參數來自定義複查系統：

```env
# 內容審核複查配置
MODERATION_REVIEW_ENABLED=True
MODERATION_REVIEW_AI_SERVICE=azureopenai  # 可選: azureopenai, gemini 等
MODERATION_REVIEW_MODEL=gpt-4o  # 使用的模型名稱
MODERATION_REVIEW_CONTEXT_MESSAGES=3  # 考慮的上下文訊息數量
```

### 配置項說明

- `MODERATION_REVIEW_ENABLED`：是否啟用審核複查系統 (True/False)
- `MODERATION_REVIEW_AI_SERVICE`：用於複查的 AI 服務，如果未設置，默認使用與主要 AI 相同的服務
- `MODERATION_REVIEW_MODEL`：用於複查的模型，如果未設置，默認使用與主要 AI 相同的模型
- `MODERATION_REVIEW_CONTEXT_MESSAGES`：複查時考慮的先前訊息數量，用於提供上下文

## 技術實現

系統主要由以下組件組成：

1. **審核複查代理 (app/ai/agents/moderation_review.py)**：負責評估被標記內容
2. **AI 選擇器 (app/ai/ai_select.py)**：用於初始化和選擇適當的 AI 模型
3. **審核流程 (main.py)**：整合審核 API 和複查系統

### 審核複查代理

審核複查代理使用專門設計的提示，指導 AI 模型評估內容是否真的違規。它會考慮：

- 語言和文化背景
- 特殊術語和名稱（如歌曲、書籍、電影名稱）
- 用戶意圖
- 上下文訊息

### 審核結果

審核複查系統會生成兩種可能的結果：

- **真實違規**：確認內容確實違反社群規範，並說明具體原因
- **誤判**：確認內容被錯誤標記，提供誤判原因解釋

## 使用案例

本功能特別適用於以下情況：

1. **多語言環境**：某些語言中的正常詞彙可能在翻譯後被誤判為不當內容
2. **藝術與文化討論**：關於歌曲、書籍、電影等可能包含敏感名稱的討論
3. **專業術語**：某些領域的專業術語可能與敏感內容相似
4. **教育內容**：學術或教育目的的討論，雖然涉及敏感話題但不具傷害性

## 注意事項

- 複查系統會增加處理審核的時間，但可以顯著減少誤判
- 確保選擇的模型具有足夠的理解能力和背景知識
- 複查系統不會影響明顯違規的內容處理
- 如果複查過程出錯，系統會退回到標準審核流程，確保安全第一 