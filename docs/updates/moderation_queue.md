# 審核隊列系統更新

## 更新日期
2024-04-23

## 概述
為解決大量訊息同時需要審核時可能導致的 API 負荷問題，我們新增了審核隊列系統。這個系統可以將審核請求排入隊列中，按照配置的並發限制逐一處理，確保所有訊息都能被處理，即使在高峰期也不會因 API 限制而丟失審核任務。

## 主要功能

### 1. 排隊處理機制
- 自動將超出處理能力的審核請求加入隊列
- 按照先進先出 (FIFO) 原則依序處理所有請求
- 支持配置最大並發處理數，避免 API 限流

### 2. 自動重試機制
- 對失敗的審核請求自動進行重試
- 可配置最大重試次數和重試間隔
- 記錄失敗原因，協助診斷問題

### 3. 後台監控功能
- 實時日誌顯示隊列狀態和處理進度
- 記錄隊列長度、處理中任務數、已處理和失敗任務數
- 無需額外命令即可在後台監控處理情況

### 4. 可靠性保障
- 即使系統重啟，未處理完成的任務也會保留在隊列中
- 對於消息已刪除等特殊情況進行優雅處理
- 確保所有有效訊息最終都能被審核

## 技術實現

審核隊列系統基於 Python 的 `asyncio` 實現，主要組件包括：

1. **隊列管理器（ModerationQueue）**：負責維護任務隊列和處理線程
2. **任務包裝器**：將消息和處理函數包裝為任務並加入隊列
3. **執行器**：控制任務的並發執行和結果處理
4. **監控組件**：記錄處理狀態和統計信息

系統流程：
```
用戶發送消息 → 消息進入審核隊列 → 隊列按配置並發數處理消息 → 
審核結果處理（刪除/禁言等操作）→ 隊列繼續處理下一批消息
```

## 配置選項

在 `.env` 文件中可以進行以下配置：

```env
# 審核隊列設置
MODERATION_QUEUE_ENABLED=True                # 是否啟用審核隊列
MODERATION_QUEUE_MAX_CONCURRENT=3            # 最大同時處理任務數
MODERATION_QUEUE_CHECK_INTERVAL=1.0          # 隊列檢查間隔（秒）
MODERATION_QUEUE_RETRY_INTERVAL=5.0          # 重試間隔（秒）
MODERATION_QUEUE_MAX_RETRIES=5               # 最大重試次數
```

## 日誌輸出示例

```
[審核隊列] 隊列處理服務已啟動
[審核隊列] 新任務添加: task_1714024536_1234567890, 用戶: user123, 當前隊列長度: 1, 處理中: 0
[審核隊列] 開始處理: task_1714024536_1234567890, 用戶: user123
[審核] 開始評估內容是否為誤判，被標記類型: harassment
[審核隊列] 處理完成: task_1714024536_1234567890, 用戶: user123
[審核隊列] 狀態 - 待處理: 5, 處理中: 3, 已處理: 42, 失敗: 2
```

## 效能考量

- 採用非阻塞處理方式，不會影響機器人的其他功能
- 默認配置下，每秒處理 3 個審核請求，避免超出API限制
- 支持動態調整配置以適應不同的服務器負載

## 使用指南

審核隊列系統自動在後台運行，無需特殊操作。管理員可以通過以下方式優化系統：

1. 根據服務器規模調整並發處理數
2. 在高峰期前適當調高並發數以應對流量
3. 關注後台日誌中的隊列狀態

## 未來改進計劃

- 添加隊列優先級機制，允許某些消息優先處理
- 實現隊列持久化，在機器人重啟後恢復未處理的任務
- 添加隊列統計命令，讓管理員可查詢處理狀態
- 針對特殊頻道配置不同的處理策略 