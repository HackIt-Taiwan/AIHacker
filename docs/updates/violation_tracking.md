# 違規追蹤系統優化

日期：2024年6月28日

## 更新內容

為提高使用者體驗並避免因訊息排隊審核造成的重複處罰，我們新增了違規追蹤機制，優化了審核系統的行為。

### 變更摘要

1. **單一時間窗口處罰**：
   - 系統現在會追蹤最近被處罰的使用者
   - 在設定的時間窗口內（預設5分鐘），同一使用者的多次違規只會被處罰一次
   - 後續的違規訊息只會被刪除，不會重複發送通知或增加禁言時間

2. **解決訊息隊列問題**：
   - 當使用者發送多條違規訊息時，這些訊息會進入審核隊列依序被處理
   - 在過去的實現中，每條訊息都會導致獨立的處罰和通知
   - 現在使用者會在第一次違規時收到通知和處罰，但後續違規只會刪除訊息

3. **改進使用者體驗**：
   - 避免使用者因多則違規訊息而收到大量重複通知
   - 給予使用者時間了解規則後再實施進一步的處罰
   - 仍然確保所有違規內容都被刪除以維護社群環境

### 技術實現

1. **追蹤機制**：
   - 使用 `tracked_violators` 字典來追蹤最近被處罰的使用者
   - 字典的鍵是使用者ID，值是處罰過期的時間戳
   - 設定了 `VIOLATION_TRACKING_WINDOW` 常數（預設300秒）作為處罰追蹤的時間窗口

2. **處理流程**：
   - 當訊息被判定為違規時，系統會檢查使用者是否在追蹤名單中
   - 如果使用者最近已被處罰且尚未過期，系統只會刪除訊息而不進行禁言或發送通知
   - 如果使用者不在名單中或追蹤已過期，則正常處理違規（刪除訊息、通知使用者、應用禁言）

3. **記憶體管理**：
   - 為防止 `tracked_violators` 字典無限增長，系統會在字典大小超過1000項時清理過期項目
   - 過期的追蹤記錄會自動從字典中移除

### 工作原理

1. 使用者發送違規訊息
2. 系統判定訊息違規並刪除
3. 系統檢查使用者是否在5分鐘內已被處罰
   - 如果是，則只刪除訊息並停止處理
   - 如果否，則進行完整處罰流程並將使用者加入追蹤名單
4. 使用者在5分鐘內再次發送違規訊息
5. 系統只刪除訊息，不增加禁言時間或發送通知

### 預期效果

該更新將帶來以下改進：

1. **減少通知轟炸**：使用者不會因為發送多條違規訊息而收到大量重複通知
2. **更合理的處罰機制**：給予使用者時間了解和調整行為
3. **降低服務器負載**：減少不必要的通知發送和資料庫操作
4. **更好的使用者體驗**：避免使用者因大量通知而感到困惑或不滿

## 注意事項

- 違規計數仍會正確記錄在資料庫中，不會因為這個機制而遺漏
- 時間窗口（5分鐘）是預設值，可以根據需要調整
- 這個機制只影響通知和即時禁言，不影響違規記錄的保存和長期統計 